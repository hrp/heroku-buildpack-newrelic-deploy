#!/usr/bin/env bash

export_env_dir() {
  env_dir=$3
  echo $env_dir
  whitelist_regex=${2:-'^(NEW_RELIC_API_KEY|NEW_RELIC_APP_NAME)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e"
      echo "$e" | grep -E "$whitelist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

export_env_dir

# We record the release
echo "Sending deployment notice to NewRelic for \"$NEW_RELIC_APP_NAME\""
curl -H "x-api-key:$NEW_RELIC_API_KEY" -d "deployment[app_name]=$NEW_RELIC_APP_NAME" https://api.newrelic.com/deployments.xml
