#!/usr/bin/env bash

env_dir=$3
whitelist_regex=${2:-'^(NEW_RELIC_API_KEY|NEW_RELIC_APP_NAME)$'}
if [ -d "$env_dir" ]; then
  for e in $(ls $env_dir); do
    echo "$e" | grep -E "$whitelist_regex" &&
    export "$e=$(cat $env_dir/$e)"
    :
  done
fi

# We record the release
echo "Sending deployment notice to NewRelic for \"$NEW_RELIC_APP_NAME\""
curl -H "x-api-key:$NEW_RELIC_API_KEY" -d "deployment[app_name]=$NEW_RELIC_APP_NAME" https://api.newrelic.com/deployments.xml
